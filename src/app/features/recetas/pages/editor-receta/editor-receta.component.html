<div class="recipe-editor animate-up">
  <header class="inventory-header">
    <div class="header-content">
      <button class="btn-back btn-tap" routerLink="/dashboard">‚Üê</button>
      <h1>{{ esEdicion ? 'Editar Plato' : 'Nueva Receta' }} üìñ</h1>
    </div>
  </header>

  <form [formGroup]="recetaForm" (ngSubmit)="guardarReceta()" class="form-layout">
    
    <section class="glass-card main-config">
      <div class="input-group">
        <label>Nombre del Plato</label>
        <input type="text" formControlName="nombre" placeholder="Ej: Lomo Saltado" class="glass-input">
      </div>
      
      <div class="portions-row">
        <label>Rinde para:</label>
        <div class="stepper-glass">
          <button type="button" class="btn-step btn-tap" (click)="ajustarPorciones(-1)">-</button>
          <input type="number" formControlName="porciones" readonly>
          <button type="button" class="btn-step btn-tap" (click)="ajustarPorciones(1)">+</button>
          <span class="unit">Porciones</span>
        </div>
      </div>
    </section>

    <section class="ingredients-container">
      <div class="section-title">
        <h3>Ingredientes</h3>
        <button type="button" class="btn-add-orange" (click)="agregarIngrediente()">+ A√±adir Insumo</button>
      </div>

      <div formArrayName="ingredientes" class="ingredients-stack">
        @for (ing of ingredientesForm.controls; track $index) {
          <div [formGroupName]="$index" class="glass-card ingredient-item animate-up">
            <div class="item-grid">
              <div class="field">
                <label>Insumo</label>
                <select formControlName="insumo_id" (change)="actualizarCalculos()" class="glass-input">
                  <option value="">Buscar en despensa...</option>
                  @for (ins of insumos; track ins.id) {
                    <option [value]="ins.id">{{ ins.nombre }}</option>
                  }
                </select>
              </div>
              <div class="field">
                <label>Cantidad (gr/ml)</label>
                <input type="number" formControlName="cantidad" (input)="actualizarCalculos()" class="glass-input" placeholder="0">
              </div>
            </div>
            
            <div class="item-footer">
              <span class="subtotal">Costo: <strong>S/ {{ ing.get('costo')?.value | number:'1.2-2' }}</strong></span>
              <button type="button" class="btn-remove-red" (click)="removerIngrediente($index)">Eliminar</button>
            </div>
          </div>
        }
      </div>
    </section>

    <div class="floating-summary glass-card-heavy animate-slide-up">
      <div class="summary-content">
        <div class="summary-block">
          <small>Costo Total</small>
          <span class="value">S/ {{ recetaForm.get('costo_total')?.value | number:'1.2-2' }}</span>
        </div>
        <div class="separator"></div>
        <div class="summary-block highlight">
          <small>Por Plato</small>
          <span class="value-accent">S/ {{ costoPorPlato | number:'1.2-2' }}</span>
        </div>
      </div>
      <button type="submit" class="btn-primary-glow btn-tap" [disabled]="recetaForm.invalid">
        Guardar Receta
      </button>
    </div>
  </form>
</div>