<div class="mobile-container">
    <header class="app-header">
        <div class="header-content">
            <span class="back-icon" routerLink="/dashboard">‚Üê</span>
            <h1>Nuevo Plato</h1>
            <div class="user-badge">üë®‚Äçüç≥</div>
        </div>
    </header>

    <form [formGroup]="recetaForm" (ngSubmit)="guardarReceta()" class="glass-form">

        <section class="form-section animate-up">
            <div class="floating-label">
                <input type="text" formName="nombre" placeholder=" " id="nombre">
                <label for="nombre">Nombre de la creaci√≥n</label>
            </div>

            <div class="counter-container">
                <label>Porciones:</label>
                <div class="counter-controls">
                    <button type="button" (click)="ajustarPorciones(-1)" [disabled]="porcionesActuales <= 1">-</button>

                    <span>{{ porcionesActuales }}</span>

                    <button type="button" (click)="ajustarPorciones(1)">+</button>
                </div>
            </div>
        </section>

        <section class="ingredients-list animate-up-delay-1">
            <div class="list-header">
                <h3>Ingredientes</h3>
                <button type="button" class="btn-add-circle" (click)="agregarIngrediente()">+</button>
            </div>

            <div formArrayName="ingredientes" class="cards-stack">
                @for (ing of ingredientes.controls; track $index) {
                <div [formGroupName]="$index" class="ingredient-card animate-pop">
                    <div class="card-body">
                        <select formControlName="insumo_id" (change)="onIngredienteChange($index)">
                            <option value="">Seleccionar Insumo</option>
                            @for (i of insumosDisponibles; track i.id) {
                            <option [value]="i.id">{{ i.nombre }}</option>
                            }
                        </select>

                        <div class="card-inputs">
                            <div class="input-with-unit">
                                <input type="number" formControlName="cantidad" (input)="onIngredienteChange($index)"
                                    placeholder="0">
                                <small>gr/ml</small>
                            </div>
                            <div class="price-tag">
                                S/ {{ ing.get('costo_parcial')?.value }}
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn-remove" (click)="removerIngrediente($index)">√ó</button>
                </div>
                }
            </div>
        </section>

        <footer class="sticky-footer">
            <div class="cost-summary">
                <div class="summary-item">
                    <small>Total Lote</small>
                    <strong>S/ {{ costoTotalReceta | number:'1.2-2' }}</strong>
                </div>
                <div class="summary-item highlight">
                    <small>Por Porci√≥n</small>
                    <strong>S/ {{ (costoTotalReceta / recetaForm.get('porciones')?.value!) | number:'1.2-2' }}</strong>
                </div>
            </div>
            <button type="submit" [disabled]="recetaForm.invalid" class="btn-submit-main">
                Guardar Receta
            </button>
        </footer>
    </form>
</div>