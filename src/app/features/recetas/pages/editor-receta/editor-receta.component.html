<div class="recipe-editor animate-up">
  <header class="inventory-header">
    <div class="header-content">
      <h1>{{ esEdicion ? 'Editar Plato' : 'Nueva Receta' }} üìñ</h1>
    </div>
  </header>

  <form [formGroup]="recetaForm" (ngSubmit)="guardarReceta()" class="editor-grid">

    <div class="main-content">
      <section class="glass-card main-config">
        <div class="input-glass-group">
          <label>Nombre de la Receta</label>
          <input type="text" formControlName="nombre" placeholder="Ej: Ceviche Clasico" class="glass-input">
        </div>

        <div class="portions-row">
          <label>Rinde para (porciones):</label>
          <div class="stepper-glass">
            <button type="button" (click)="ajustarPorciones(-1)" class="btn-tap">-</button>
            <input type="number" formControlName="porciones" readonly>
            <button type="button" (click)="ajustarPorciones(1)" class="btn-tap">+</button>
          </div>
        </div>
      </section>

      <div class="section-title">
        <h3>Ingredientes del Plato</h3>
        <button type="button" class="btn-add-orange btn-tap" (click)="agregarIngrediente()">+ A√±adir Insumo</button>
      </div>

      <div formArrayName="ingredientes" class="insumos-stack">
        @for (ing of ingredientesForm.controls; track $index) {
        <div [formGroupName]="$index" class="glass-card ingredient-item animate-up">
          <div class="item-grid">
            <div class="input-glass-group">
              <label>Insumo</label>
              <select formControlName="insumo_id" (change)="actualizarCalculos()" class="glass-input">
                <option value="">Buscar en despensa...</option>
                @for (ins of insumos; track ins.id) {
                <option [value]="ins.id">{{ ins.nombre }}</option>
                }
              </select>
            </div>

            <div class="input-glass-group">
              <label>Cantidad (gr/ml)</label>
              <input type="number" formControlName="cantidad" (input)="actualizarCalculos()" class="glass-input"
                placeholder="0">
            </div>
          </div>

          <div class="item-footer">
            <div class="cost-badge">
              <span>Costo:</span>
              <strong>S/ {{ ing.get('costo')?.value | number:'1.2-2' }}</strong>
            </div>
            <button type="button" class="btn-icon-delete btn-tap" (click)="pedirConfirmacionEliminar($index)"> üóëÔ∏è
            </button>
          </div>
        </div>
        }
      </div>
    </div>

    <aside class="summary-aside">
      <div class="floating-summary glass-card-heavy">
        <div class="summary-details">
          <div class="detail-item">
            <small>Costo Total</small>
            <span>S/ {{ recetaForm.get('costo_total')?.value | number:'1.2-2' }}</span>
          </div>
          <div class="v-divider"></div>
          <div class="detail-item highlight">
            <small>Costo por Plato</small>
            <span class="orange-val">S/ {{ costoPorPlato | number:'1.2-2' }}</span>
          </div>
        </div>
        <button type="submit" class="btn-primary-glow btn-tap" [disabled]="recetaForm.invalid">
          Guardar Receta
        </button>
      </div>
    </aside>

  </form>
</div>

<app-confirm-modal 
  [visible]="showModalEliminar"
  [titulo]="'¬øEliminar Insumo?'"
  [mensaje]="'Se quitar√° este ingrediente del c√°lculo actual.'"
  [textoConfirmar]="'Eliminar Insumo'"
  (confirmar)="confirmarEliminacion()"
  (cancelar)="cerrarModal()">
</app-confirm-modal>